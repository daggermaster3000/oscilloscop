<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customizable Oscilloscope</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    
  </style>
</head>
<body>
  <div id="controls">
    <div class="window-header" id="controlsHeader">
      <span class="window-title">Oscilloscope Controls</span>
      <div class="window-spacer"></div>
      <button class="retro-btn" id="tutorialBtn" title="Start tutorial">Tutorial</button>
      <button class="retro-btn" id="instructionsBtn">Instructions</button>
      <button class="retro-btn" id="collapseBtn">Collapse</button>
      <button class="retro-btn" id="HomeBtn">Home</button>
    </div>
    <div class="window-body">
      <label>
        Input Source:
        <select id="inputSource">
          <option value="file">Audio File</option>
          <option value="mic">Microphone / Audio Interface</option>
        </select>
      </label>

      <label id="deviceLabel" style="display: none;">
        Audio Device:
        <select id="audioDevices"></select>
      </label>

      <label id="fileLabel">
        Upload Audio:
        <input type="file" id="audioFile" accept="audio/*">
      </label>
      <button id="playPauseBtn" disabled>Play</button>

      <label>
        Theme:
        <select id="themeSelect">
          <option value="green">Retro Green</option>
          <option value="blue">Sci-fi Blue</option>
          <option value="amber">Amber Orange</option>
          <option value="red">Night Vision Red</option>
          <option value="cartoon">Cartoon Split</option>
          <option value="scientific">Scientific Neon</option>
          <option value="modern">Modern Blue</option>
          <option value="retro">Retro Magenta</option>
          <option value="viking">Viking Bronze</option>
          <option value="cyberpunk">Cyberpunk Glow</option>
          <option value="space">Space Horizon</option>
          <option value="magma">Magma Core</option>
          <option value="aurora">Aurora Sky</option>
          <option value="storm">Electric Storm</option>
          <option value="ocean">Ocean Deep</option>
          <option value="lava">Lava Flow</option>
          <option value="pastel">Pastel Dream</option>
          <option value="minimal">Minimal Contrast</option>
        </select>
      </label>

      <label>
        Display Mode:
        <select id="displayMode">
          <option value="waveform">Waveform</option>
          <option value="fft">FFT Spectrum</option>
          <option value="stereo">Stereo Phase</option>
          <option value="3D Waveform flat">3D waveform flat</option>
          <option value="3D Waveform top">3D waveform top</option>
          <option value="3D Spectrogram">3D spectrogram</option>
          <option value="2D Spectrogram">2D spectrogram</option>
          <option value="Particle Cloud">Particle Cloud</option>
          <option value="3D Mesh">3D Mesh</option>
          <option value="Fourier Series Shape">Fourier Series Shape</option>
          <option value="Polygon Morph">Polygon Morph</option>
          <option value="Harmonic Orbital Systems">Harmonic Orbital Systems</option>
          <option value="Game of Life">Game of Life</option>
        </select>
      </label>

      <div class="control-section">
        <h3>Adjustments</h3>
        <div id="knobControls"></div>
      </div>

      <div class="control-section">
        <h3>Audio-Reactive Filters</h3>
        <label>
          Filter Effect:
          <select id="filterEffect">
            <option value="none">None</option>
            <option value="grain">Grain</option>
            <option value="scanlines">Scanlines</option>
            <option value="chromatic">Chromatic Aberration</option>
            <option value="glitch">Glitch</option>
            <option value="vhs">VHS Noise</option>
          </select>
        </label>
        <label>
          Filter Intensity:
          <input type="range" id="filterIntensity" min="0" max="1" step="0.05" value="0.5">
          <span id="filterIntensityValue">0.50</span>
        </label>
        <label>
          Audio Response:
          <select id="filterResponse">
            <option value="frequency">Frequency (FFT)</option>
            <option value="amplitude">Amplitude (Time-domain)</option>
            <option value="beat">Beat Detection</option>
          </select>
        </label>
        <label>
          Response Strength:
          <input type="range" id="filterResponseStrength" min="0" max="1" step="0.05" value="0.5">
          <span id="filterResponseStrengthValue">0.50</span>
        </label>
      </div>

      <div class="control-section" id="particleControls">
        <h3>Particle Cloud</h3>
        <label>
          Audio Response:
          <select id="particleResponse">
            <option value="fft">Frequency (FFT)</option>
            <option value="signal">Signal (Time-domain)</option>
          </select>
        </label>
        <label>
          Particle Count:
          <input type="number" id="particleCount" min="100" max="20000" step="100" value="2000">
        </label>
        <label>
          Particle Size:
          <input type="range" id="particleSize" min="1" max="8" step="0.5" value="2">
          <span id="particleSizeValue">2</span>
        </label>

        <details id="equationDetails">
          <summary>Equations (x(u,v,t,a), y(u,v,t,a), z(u,v,t,a))</summary>
          <div style="display:flex; flex-direction:column; gap:6px; margin-top:6px;">
            <label>
              Preset Shape:
              <select id="equationPreset">
                <option value="sphere">Sphere</option>
                <option value="torus">Torus</option>
                <option value="helix">Helix</option>
                <option value="lissajous">Lissajous Knot</option>
                <option value="torusKnot">Torus Knot (p=2,q=3)</option>
                <option value="mobius">Möbius Strip</option>
                <option value="highway">Highway</option>
              </select>
              <button class="retro-btn" id="equationResetBtn">Reset</button>
            </label>
            <small>u ∈ [0,1], v ∈ [0,1], t = seconds, a = avg amplitude [0,1]</small>
            <label>
              x(u,v,t,a):
              <input type="text" id="eqX" value="Math.sin(Math.PI*v)*Math.cos(2*Math.PI*u)">
            </label>
            <label>
              y(u,v,t,a):
              <input type="text" id="eqY" value="Math.sin(Math.PI*v)*Math.sin(2*Math.PI*u)">
            </label>
            <label>
              z(u,v,t,a):
              <input type="text" id="eqZ" value="Math.cos(Math.PI*v)">
            </label>
          </div>
        </details>

        <details id="rotationDetails">
          <summary>Rotation</summary>
          <div style="display:flex; flex-direction:column; gap:6px; margin-top:6px;">
            <label>
              Rotation Preset:
              <select id="rotatePreset">
                <option value="none">None</option>
                <option value="spinY">Spin Y</option>
                <option value="spinX">Spin X</option>
                <option value="spinZ">Spin Z</option>
                <option value="tumble">Tumble XYZ</option>
                <option value="orbitXY">Orbit XY</option>
              </select>
            </label>
            <label>
              <input type="checkbox" id="rotateX" checked>
              Rotate X
              <input type="range" id="rotateXSpeed" min="-2" max="2" step="0.01" value="0.30">
              <span id="rotateXSpeedValue">0.30</span> rad/s
            </label>
            <label>
              <input type="checkbox" id="rotateY" checked>
              Rotate Y
              <input type="range" id="rotateYSpeed" min="-2" max="2" step="0.01" value="0.60">
              <span id="rotateYSpeedValue">0.60</span> rad/s
            </label>
            <label>
              <input type="checkbox" id="rotateZ">
              Rotate Z
              <input type="range" id="rotateZSpeed" min="-2" max="2" step="0.01" value="0.20">
              <span id="rotateZSpeedValue">0.20</span> rad/s
            </label>
            <hr style="border: 1px solid rgba(255,255,255,0.2); margin: 10px 0;">
            <label>
              <input type="checkbox" id="audioRotation">
              Audio-Driven Rotation
            </label>
            <label>
              Rotation Source:
              <select id="audioRotationSource">
                <option value="frequency">Frequency (FFT)</option>
                <option value="amplitude">Amplitude (Time-domain)</option>
              </select>
            </label>
            <label>
              Rotation Intensity:
              <input type="range" id="audioRotationIntensity" min="0" max="5" step="0.1" value="1.0">
              <span id="audioRotationIntensityValue">1.0</span>
            </label>
          </div>
        </details>

        <details id="morphDetails">
          <summary>Audio Morphing</summary>
          <div style="display:flex; flex-direction:column; gap:6px; margin-top:6px;">
            <label>
              <input type="checkbox" id="audioMorph">
              Enable Audio Morphing
            </label>
            <label>
              Morph Source:
              <select id="audioMorphSource">
                <option value="frequency">Frequency (FFT)</option>
                <option value="amplitude">Amplitude (Time-domain)</option>
              </select>
            </label>
            <label>
              Morph Intensity:
              <input type="range" id="audioMorphIntensity" min="0" max="2" step="0.05" value="0.5">
              <span id="audioMorphIntensityValue">0.5</span>
            </label>
            <small>Shape morphs by modulating equation parameters with audio</small>
          </div>
        </details>
      </div>

      <div class="control-section" id="meshControls">
        <h3>3D Mesh</h3>
        <label>
          Audio Response:
          <select id="meshResponse">
            <option value="fft">Frequency (FFT)</option>
            <option value="signal">Signal (Time-domain)</option>
          </select>
        </label>
        <label>
          Mesh Resolution:
          <input type="range" id="meshResolution" min="10" max="100" step="5" value="30">
          <span id="meshResolutionValue">30</span>
        </label>
        <label>
          <input type="checkbox" id="meshWireframe" checked>
          Wireframe Mode
        </label>
        <label>
          <input type="checkbox" id="meshFilled">
          Filled Polygons
        </label>

        <details id="meshEquationDetails">
          <summary>Mesh Equations (x(u,v,t,a), y(u,v,t,a), z(u,v,t,a))</summary>
          <div style="display:flex; flex-direction:column; gap:6px; margin-top:6px;">
            <label>
              Preset Shape:
              <select id="meshEquationPreset">
                <option value="sphere">Sphere</option>
                <option value="torus">Torus</option>
                <option value="wave">Wave Surface</option>
                <option value="ripple">Ripple</option>
                <option value="terrain">Terrain</option>
                <option value="morphSphere">Morph: Pulsing Sphere</option>
                <option value="morphTorus">Morph: Breathing Torus</option>
                <option value="morphWave">Morph: Wave Distortion</option>
              </select>
              <button class="retro-btn" id="meshEquationResetBtn">Reset</button>
            </label>
            <small>u ∈ [0,1], v ∈ [0,1], t = seconds, a = avg amplitude [0,1]</small>
            <label>
              x(u,v,t,a):
              <input type="text" id="meshEqX" value="Math.sin(Math.PI*v)*Math.cos(2*Math.PI*u)">
            </label>
            <label>
              y(u,v,t,a):
              <input type="text" id="meshEqY" value="Math.sin(Math.PI*v)*Math.sin(2*Math.PI*u)">
            </label>
            <label>
              z(u,v,t,a):
              <input type="text" id="meshEqZ" value="Math.cos(Math.PI*v)">
            </label>
          </div>
        </details>

        <details id="meshRotationDetails">
          <summary>Rotation</summary>
          <div style="display:flex; flex-direction:column; gap:6px; margin-top:6px;">
            <label>
              <input type="checkbox" id="meshRotateX" checked>
              Rotate X
              <input type="range" id="meshRotateXSpeed" min="-2" max="2" step="0.01" value="0.30">
              <span id="meshRotateXSpeedValue">0.30</span> rad/s
            </label>
            <label>
              <input type="checkbox" id="meshRotateY" checked>
              Rotate Y
              <input type="range" id="meshRotateYSpeed" min="-2" max="2" step="0.01" value="0.60">
              <span id="meshRotateYSpeedValue">0.60</span> rad/s
            </label>
            <label>
              <input type="checkbox" id="meshRotateZ">
              Rotate Z
              <input type="range" id="meshRotateZSpeed" min="-2" max="2" step="0.01" value="0.20">
              <span id="meshRotateZSpeedValue">0.20</span> rad/s
            </label>
          </div>
        </details>
      </div>

      <div class="control-section" id="fourierControls">
        <h3>Fourier Series</h3>
        <label>
          Harmonics:
          <input type="range" id="fourierHarmonics" min="1" max="64" step="1" value="16">
          <span id="fourierHarmonicsValue">16</span>
        </label>
        <label>
          Contribution:
          <input type="range" id="fourierContribution" min="0" max="1" step="0.01" value="0.20">
          <span id="fourierContributionValue">0.20</span>
        </label>
      </div>

      <div class="control-section" id="orbitalsControls">
        <h3>Harmonic Orbitals</h3>
        <label>
          <input type="checkbox" id="orbitalsShowPaths" checked>
          Show Orbit Paths
        </label>
        <label>
          Planet Size:
          <input type="range" id="orbitalsPlanetSize" min="1" max="10" step="0.5" value="3">
          <span id="orbitalsPlanetSizeValue">3.0</span>
        </label>
        <label>
          <input type="checkbox" id="orbitals3D" checked>
          3D Mode
        </label>
        <label>
          Tilt (deg):
          <input type="range" id="orbitalsTilt" min="-90" max="90" step="1" value="-30">
          <span id="orbitalsTiltValue">-30</span>
        </label>
        <label>
          Depth:
          <input type="range" id="orbitalsDepth" min="200" max="1200" step="10" value="700">
          <span id="orbitalsDepthValue">700</span>
        </label>
        <label>
          Spin Speed (rad/s):
          <input type="range" id="orbitalsSpin" min="0" max="2" step="0.01" value="0.4">
          <span id="orbitalsSpinValue">0.40</span>
        </label>
      </div>

      <div class="control-section" id="golControls">
        <h3>Game of Life</h3>
        <label>
          Cell Size (px):
          <input type="range" id="golCellSize" min="1" max="12" step="1" value="3">
          <span id="golCellSizeValue">3</span>
        </label>
        <label>
          Reseed Intensity:
          <input type="range" id="golReseed" min="0" max="1" step="0.01" value="0.30">
          <span id="golReseedValue">0.30</span>
        </label>
        <label>
          Birth Boost Threshold:
          <input type="range" id="golBirthBoost" min="0" max="1" step="0.01" value="0.30">
          <span id="golBirthBoostValue">0.30</span>
        </label>
        <label>
          Survival Boost Threshold:
          <input type="range" id="golSurvivalBoost" min="0" max="1" step="0.01" value="0.45">
          <span id="golSurvivalBoostValue">0.45</span>
        </label>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="instructionsModal">
    <div class="modal">
      <header>How to Use ⚙️</header>
      <div class="content white-text">
        <ul>
          <li>
            <strong>Input Source:</strong> Use Audio File or Microphone (allow permission if prompted). Switch devices if no signal.
          </li>
          <li>
            <strong>Display Modes:</strong>
            <ul>
              <li>Waveform / FFT / Stereo Phase: classic oscilloscope views with Afterglow, Smoothing, and Line Width controls.</li>
              <li>3D Waveform (flat/top) and 3D/2D Spectrogram: time/frequency landscapes with perspective and grid.</li>
              <li>Particle Cloud: parametric 3D shapes driven by audio. Edit equations x(u,v,t,a), y(u,v,t,a), z(u,v,t,a), choose presets, and control per‑axis rotation and speed.</li>
              <li>Fourier Series Shape: audio builds a radial shape from harmonics. Set Harmonics and Contribution. (still work in progress)</li>
              <li>Polygon Morph: audio morphs sides, rotation, and radius for geometric shapes.</li>
              <li>Harmonic Orbital Systems: audio‑scaled planets orbit with optional 3D tilt, depth, spin; toggle orbit paths, set planet size.</li>
              <li>Game of Life: audio injects life/noise and biases rules. Tune Cell Size, Reseed, Birth/Survival thresholds.</li>
            </ul>
          </li>
          <li>
            <strong>Theme & UI:</strong> pick a theme; controls are scrollable. Knobs update styling with theme changes.
          </li>
          <li>
            <strong>Copy/Share:</strong> use “Copy Settings URL” to share the exact configuration. Loading a URL restores all controls (display mode, particle equations/rotation, Fourier/orbitals/GoL settings, etc...).
          </li>
          <li>
            <strong>Tips:</strong> increase Particle Count or decrease GoL Cell Size for denser visuals; switch Audio Response between FFT and Signal for different motion; Adjust survival boost for GoL to respond to different audio dynamics
          </li>
        </ul>
      </div>
      <footer>
        <button class="retro-btn" style="color:white; border: 1px solid white;" id="closeInstructions">Close</button>
      </footer>
    </div>
  </div>

  <canvas id="oscilloscope"></canvas>

  <script src="js/themes.js"></script>
  <script src="js/knob.js"></script>
  <script src="js/audio.js"></script>
  <script src="js/visualizer.js"></script>
  <script src="js/main.js"></script>
  <script src="js/onboarding.js"></script>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // --- Draggable controls ---
    const controls = document.getElementById('controls');
    const header = document.getElementById('controlsHeader');
    let pos = {x:0,y:0}, dragging=false, origin={x:0,y:0};
    header.addEventListener('mousedown', (e)=>{
      dragging = true; origin.x = e.clientX; origin.y = e.clientY;
      const rect = controls.getBoundingClientRect(); pos.x = rect.left; pos.y = rect.top;
      document.body.style.cursor = 'move';
    });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.cursor='default'; });
    window.addEventListener('mousemove', (e)=>{
      if(!dragging) return;
      const dx = e.clientX - origin.x; const dy = e.clientY - origin.y;
      controls.style.left = (pos.x + dx) + 'px';
      controls.style.top = (pos.y + dy) + 'px';
    });
    // Collapse toggle
    const collapseBtn = document.getElementById('collapseBtn');
    collapseBtn.addEventListener('click', ()=>{
      controls.classList.toggle('window-collapsed');
      collapseBtn.textContent = controls.classList.contains('window-collapsed') ? 'Expand' : 'Collapse';
    });
    // Instructions modal
    const modal = document.getElementById('instructionsModal');
    document.getElementById('instructionsBtn').addEventListener('click', ()=>{ modal.style.display = 'flex'; });
    document.getElementById('closeInstructions').addEventListener('click', ()=>{ modal.style.display = 'none'; });
    modal.addEventListener('click', (e)=>{ if(e.target === modal) modal.style.display='none'; });
    
    // Tutorial button
    document.getElementById('tutorialBtn').addEventListener('click', ()=>{
      if (window.onboardingInstance) {
        window.onboardingInstance.restart();
      }
    });

    document.getElementById("HomeBtn").addEventListener("click", () => {
  // Go to home.html (or index.html)
  window.location.href = "index.html"; // change to "index.html" if needed
});

    // --- SETTINGS TO URL ---
    const themeSelect = document.getElementById("themeSelect");
    const displayMode = document.getElementById("displayMode");

    if (!themeSelect || !displayMode) return;

    // Load settings from URL
    const params = new URLSearchParams(window.location.search);
    if (params.has("theme")) themeSelect.value = params.get("theme");
    if (params.has("displayMode")) displayMode.value = params.get("displayMode");

        function updateURL() {
          const settings = {
            theme: themeSelect.value,
            displayMode: displayMode.value,
            // particle
            pResp: (document.getElementById('particleResponse')||{}).value,
            pCount: (document.getElementById('particleCount')||{}).value,
            pSize: (document.getElementById('particleSize')||{}).value,
            eqPreset: (document.getElementById('equationPreset')||{}).value,
            eqX: (document.getElementById('eqX')||{}).value,
            eqY: (document.getElementById('eqY')||{}).value,
            eqZ: (document.getElementById('eqZ')||{}).value,
            rotPreset: (document.getElementById('rotatePreset')||{}).value,
            rotX: (document.getElementById('rotateX')||{}).checked,
            rotY: (document.getElementById('rotateY')||{}).checked,
            rotZ: (document.getElementById('rotateZ')||{}).checked,
            rotXS: (document.getElementById('rotateXSpeed')||{}).value,
            rotYS: (document.getElementById('rotateYSpeed')||{}).value,
            rotZS: (document.getElementById('rotateZSpeed')||{}).value,
            // audio rotation
            aRot: (document.getElementById('audioRotation')||{}).checked,
            aRotSrc: (document.getElementById('audioRotationSource')||{}).value,
            aRotInt: (document.getElementById('audioRotationIntensity')||{}).value,
            // audio morph
            aMorph: (document.getElementById('audioMorph')||{}).checked,
            aMorphSrc: (document.getElementById('audioMorphSource')||{}).value,
            aMorphInt: (document.getElementById('audioMorphIntensity')||{}).value,
            // mesh
            mResp: (document.getElementById('meshResponse')||{}).value,
            mRes: (document.getElementById('meshResolution')||{}).value,
            mWire: (document.getElementById('meshWireframe')||{}).checked,
            mFill: (document.getElementById('meshFilled')||{}).checked,
            mEqPreset: (document.getElementById('meshEquationPreset')||{}).value,
            mEqX: (document.getElementById('meshEqX')||{}).value,
            mEqY: (document.getElementById('meshEqY')||{}).value,
            mEqZ: (document.getElementById('meshEqZ')||{}).value,
            mRotX: (document.getElementById('meshRotateX')||{}).checked,
            mRotY: (document.getElementById('meshRotateY')||{}).checked,
            mRotZ: (document.getElementById('meshRotateZ')||{}).checked,
            mRotXS: (document.getElementById('meshRotateXSpeed')||{}).value,
            mRotYS: (document.getElementById('meshRotateYSpeed')||{}).value,
            mRotZS: (document.getElementById('meshRotateZSpeed')||{}).value,
            // filters
            fEff: (document.getElementById('filterEffect')||{}).value,
            fInt: (document.getElementById('filterIntensity')||{}).value,
            fResp: (document.getElementById('filterResponse')||{}).value,
            fRespStr: (document.getElementById('filterResponseStrength')||{}).value,
            // fourier
            fH: (document.getElementById('fourierHarmonics')||{}).value,
            fC: (document.getElementById('fourierContribution')||{}).value,
            // orbitals
            oPaths: (document.getElementById('orbitalsShowPaths')||{}).checked,
            oSize: (document.getElementById('orbitalsPlanetSize')||{}).value,
            o3D: (document.getElementById('orbitals3D')||{}).checked,
            oTilt: (document.getElementById('orbitalsTilt')||{}).value,
            oDepth: (document.getElementById('orbitalsDepth')||{}).value,
            oSpin: (document.getElementById('orbitalsSpin')||{}).value,
            // gol
            golS: (document.getElementById('golCellSize')||{}).value,
            golR: (document.getElementById('golReseed')||{}).value,
            golB: (document.getElementById('golBirthBoost')||{}).value,
            golSv: (document.getElementById('golSurvivalBoost')||{}).value
          };
      const newParams = new URLSearchParams(settings);
      const newURL = `${window.location.origin}${window.location.pathname}?${newParams}`;
      window.history.replaceState({}, "", newURL);
    }

        themeSelect.addEventListener("change", updateURL);
        displayMode.addEventListener("change", updateURL);

        // wire extra controls to URL sync
        [
          'particleResponse','particleCount','particleSize','equationPreset','eqX','eqY','eqZ',
          'rotatePreset','rotateX','rotateY','rotateZ','rotateXSpeed','rotateYSpeed','rotateZSpeed',
          'audioRotation','audioRotationSource','audioRotationIntensity',
          'audioMorph','audioMorphSource','audioMorphIntensity',
          'meshResponse','meshResolution','meshWireframe','meshFilled','meshEquationPreset',
          'meshEqX','meshEqY','meshEqZ','meshRotateX','meshRotateY','meshRotateZ',
          'meshRotateXSpeed','meshRotateYSpeed','meshRotateZSpeed',
          'filterEffect','filterIntensity','filterResponse','filterResponseStrength',
          'fourierHarmonics','fourierContribution',
          'orbitalsShowPaths','orbitalsPlanetSize','orbitals3D','orbitalsTilt','orbitalsDepth','orbitalsSpin',
          'golCellSize','golReseed','golBirthBoost','golSurvivalBoost'
        ].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          const evt = (el.tagName === 'INPUT' && el.type === 'range') ? 'input' : 'change';
          el.addEventListener(evt, updateURL);
        });

        // Copy settings button
        const copyBtn = document.createElement("button");
        copyBtn.textContent = "Copy Settings URL";
        copyBtn.className = "retro-btn";
        themeSelect.parentElement.after(copyBtn);
        copyBtn.addEventListener("click", () => {
          updateURL();
          navigator.clipboard.writeText(window.location.href);
          copyBtn.textContent = "Copied!";
          setTimeout(() => copyBtn.textContent = "Copy Settings URL", 1500);
        });

        // Load settings from URL (extras)
        const trigger = (id, type) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.dispatchEvent(new Event(type || 'change', { bubbles: true }));
        };
        if (params.has('pResp')) (document.getElementById('particleResponse')||{}).value = params.get('pResp');
        if (params.has('pCount')) (document.getElementById('particleCount')||{}).value = params.get('pCount');
        if (params.has('pSize')) (document.getElementById('particleSize')||{}).value = params.get('pSize');
        if (params.has('eqPreset')) (document.getElementById('equationPreset')||{}).value = params.get('eqPreset');
        if (params.has('eqX')) (document.getElementById('eqX')||{}).value = params.get('eqX');
        if (params.has('eqY')) (document.getElementById('eqY')||{}).value = params.get('eqY');
        if (params.has('eqZ')) (document.getElementById('eqZ')||{}).value = params.get('eqZ');
        if (params.has('rotPreset')) (document.getElementById('rotatePreset')||{}).value = params.get('rotPreset');
        if (params.has('rotX')) (document.getElementById('rotateX')||{}).checked = params.get('rotX') === 'true';
        if (params.has('rotY')) (document.getElementById('rotateY')||{}).checked = params.get('rotY') === 'true';
        if (params.has('rotZ')) (document.getElementById('rotateZ')||{}).checked = params.get('rotZ') === 'true';
        if (params.has('rotXS')) (document.getElementById('rotateXSpeed')||{}).value = params.get('rotXS');
        if (params.has('rotYS')) (document.getElementById('rotateYSpeed')||{}).value = params.get('rotYS');
        if (params.has('rotZS')) (document.getElementById('rotateZSpeed')||{}).value = params.get('rotZS');
        if (params.has('aRot')) (document.getElementById('audioRotation')||{}).checked = params.get('aRot') === 'true';
        if (params.has('aRotSrc')) (document.getElementById('audioRotationSource')||{}).value = params.get('aRotSrc');
        if (params.has('aRotInt')) (document.getElementById('audioRotationIntensity')||{}).value = params.get('aRotInt');
        if (params.has('aMorph')) (document.getElementById('audioMorph')||{}).checked = params.get('aMorph') === 'true';
        if (params.has('aMorphSrc')) (document.getElementById('audioMorphSource')||{}).value = params.get('aMorphSrc');
        if (params.has('aMorphInt')) (document.getElementById('audioMorphIntensity')||{}).value = params.get('aMorphInt');
        if (params.has('mResp')) (document.getElementById('meshResponse')||{}).value = params.get('mResp');
        if (params.has('mRes')) (document.getElementById('meshResolution')||{}).value = params.get('mRes');
        if (params.has('mWire')) (document.getElementById('meshWireframe')||{}).checked = params.get('mWire') === 'true';
        if (params.has('mFill')) (document.getElementById('meshFilled')||{}).checked = params.get('mFill') === 'true';
        if (params.has('mEqPreset')) (document.getElementById('meshEquationPreset')||{}).value = params.get('mEqPreset');
        if (params.has('mEqX')) (document.getElementById('meshEqX')||{}).value = params.get('mEqX');
        if (params.has('mEqY')) (document.getElementById('meshEqY')||{}).value = params.get('mEqY');
        if (params.has('mEqZ')) (document.getElementById('meshEqZ')||{}).value = params.get('mEqZ');
        if (params.has('mRotX')) (document.getElementById('meshRotateX')||{}).checked = params.get('mRotX') === 'true';
        if (params.has('mRotY')) (document.getElementById('meshRotateY')||{}).checked = params.get('mRotY') === 'true';
        if (params.has('mRotZ')) (document.getElementById('meshRotateZ')||{}).checked = params.get('mRotZ') === 'true';
        if (params.has('mRotXS')) (document.getElementById('meshRotateXSpeed')||{}).value = params.get('mRotXS');
        if (params.has('mRotYS')) (document.getElementById('meshRotateYSpeed')||{}).value = params.get('mRotYS');
        if (params.has('mRotZS')) (document.getElementById('meshRotateZSpeed')||{}).value = params.get('mRotZS');
        if (params.has('fEff')) (document.getElementById('filterEffect')||{}).value = params.get('fEff');
        if (params.has('fInt')) (document.getElementById('filterIntensity')||{}).value = params.get('fInt');
        if (params.has('fResp')) (document.getElementById('filterResponse')||{}).value = params.get('fResp');
        if (params.has('fRespStr')) (document.getElementById('filterResponseStrength')||{}).value = params.get('fRespStr');
        if (params.has('fH')) (document.getElementById('fourierHarmonics')||{}).value = params.get('fH');
        if (params.has('fC')) (document.getElementById('fourierContribution')||{}).value = params.get('fC');
        if (params.has('oPaths')) (document.getElementById('orbitalsShowPaths')||{}).checked = params.get('oPaths') === 'true';
        if (params.has('oSize')) (document.getElementById('orbitalsPlanetSize')||{}).value = params.get('oSize');
        if (params.has('o3D')) (document.getElementById('orbitals3D')||{}).checked = params.get('o3D') === 'true';
        if (params.has('oTilt')) (document.getElementById('orbitalsTilt')||{}).value = params.get('oTilt');
        if (params.has('oDepth')) (document.getElementById('orbitalsDepth')||{}).value = params.get('oDepth');
        if (params.has('oSpin')) (document.getElementById('orbitalsSpin')||{}).value = params.get('oSpin');
        if (params.has('golS')) (document.getElementById('golCellSize')||{}).value = params.get('golS');
        if (params.has('golR')) (document.getElementById('golReseed')||{}).value = params.get('golR');
        if (params.has('golB')) (document.getElementById('golBirthBoost')||{}).value = params.get('golB');
        if (params.has('golSv')) (document.getElementById('golSurvivalBoost')||{}).value = params.get('golSv');

        // Trigger listeners to ensure state sync
        ['themeSelect','displayMode','particleResponse','particleCount','particleSize',
         'equationPreset','eqX','eqY','eqZ','rotatePreset','rotateX','rotateY','rotateZ',
         'rotateXSpeed','rotateYSpeed','rotateZSpeed',
         'audioRotation','audioRotationSource','audioRotationIntensity',
         'audioMorph','audioMorphSource','audioMorphIntensity',
         'meshResponse','meshResolution','meshWireframe','meshFilled','meshEquationPreset',
         'meshEqX','meshEqY','meshEqZ','meshRotateX','meshRotateY','meshRotateZ',
         'meshRotateXSpeed','meshRotateYSpeed','meshRotateZSpeed',
         'filterEffect','filterIntensity','filterResponse','filterResponseStrength',
         'fourierHarmonics','fourierContribution',
         'orbitalsShowPaths','orbitalsPlanetSize','orbitals3D','orbitalsTilt','orbitalsDepth','orbitalsSpin']
         .concat(['golCellSize','golReseed','golBirthBoost','golSurvivalBoost'])
          .forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const type = (el.tagName === 'INPUT' && el.type === 'range') ? 'input' : 'change';
            el.dispatchEvent(new Event(type, { bubbles: true }));
          });

  });
  </script>
</body>
</html>
