<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customizable Oscilloscope</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* Retro window header and buttons */
    #controls { user-select: none; }
    #controls.window-collapsed .window-body { display: none; }
    .window-header {
      display: flex; align-items: center; gap: 8px;
      background: rgba(0, 0, 0, 0.9);
      cursor: move;
    }
    .window-title { font-weight: bold; }
    .window-spacer { flex: 1; }
    .retro-btn {
      background: black; color: lime; border: 1px solid lime; padding: 2px 8px;
      cursor: pointer;
    }
    .retro-btn:active { background: #002000; }

    /* Instructions modal */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      display: none; align-items: center; justify-content: center; z-index: 9999;
    }
    .modal {
      background: rgba(0,0,0,0.95); color: rgb(255, 255, 255); border: 1px solid rgb(255, 255, 255); width: 520px;
      max-width: calc(100% - 32px);
    }
    .modal header { border-bottom: 1px solid rgb(255, 255, 255); padding: 8px; font-weight: bold; }
    .modal .content { padding: 12px; line-height: 1.4; }
    .modal footer { padding: 8px; border-top: 1px solid rgb(255, 255, 255); text-align: right; }
    li { color: white;}
  </style>
</head>
<body>
  <div id="controls">
    <div class="window-header" id="controlsHeader">
      <span class="window-title">Oscilloscope Controls</span>
      <div class="window-spacer"></div>
      <button class="retro-btn" id="instructionsBtn">Instructions</button>
      <button class="retro-btn" id="collapseBtn">Collapse</button>
    </div>
    <div class="window-body">
      <label>
        Input Source:
        <select id="inputSource">
          <option value="file">Audio File</option>
          <option value="mic">Microphone / Audio Interface</option>
        </select>
      </label>

      <label id="deviceLabel" style="display: none;">
        Audio Device:
        <select id="audioDevices"></select>
      </label>

      <label id="fileLabel">
        Upload Audio:
        <input type="file" id="audioFile" accept="audio/*">
      </label>
      <button id="playPauseBtn" disabled>Play</button>

      <label>
        Theme:
        <select id="themeSelect">
          <option value="green">Retro Green</option>
          <option value="blue">Sci-fi Blue</option>
          <option value="amber">Amber Orange</option>
          <option value="red">Night Vision Red</option>
          <option value="cartoon">Cartoon Split</option>
          <option value="scientific">Scientific Neon</option>
          <option value="modern">Modern Blue</option>
          <option value="retro">Retro Magenta</option>
          <option value="viking">Viking Bronze</option>
          <option value="cyberpunk">Cyberpunk Glow</option>
          <option value="space">Space Horizon</option>
          <option value="magma">Magma Core</option>
          <option value="aurora">Aurora Sky</option>
          <option value="storm">Electric Storm</option>
          <option value="ocean">Ocean Deep</option>
          <option value="lava">Lava Flow</option>
          <option value="pastel">Pastel Dream</option>
          <option value="minimal">Minimal Contrast</option>
        </select>
      </label>

      <label>
        Display Mode:
        <select id="displayMode">
          <option value="waveform">Waveform</option>
          <option value="fft">FFT Spectrum</option>
          <option value="stereo">Stereo Phase</option>
          <option value="3D Waveform flat">3D waveform flat</option>
          <option value="3D Waveform top">3D waveform top</option>
          <option value="3D Spectrogram">3D spectrogram</option>
          <option value="2D Spectrogram">2D spectrogram</option>
        </select>
      </label>

      <label>
        Afterglow:
        <input type="range" id="afterglowControl" min="0" max="100" value="92">
        <span id="afterglowValue">0.92</span>
      </label>

      <div class="control-section">
        <h3>Adjustments</h3>
        <div id="knobControls"></div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="instructionsModal">
    <div class="modal">
      <header>How to Use ⚙️</header>
      <div class="content white-text">
        <ul>
          <li>
            <strong>Choose an Input Source:</strong>
            <ul>
              <li>Audio File</li>
              <li>Microphone</li>
            </ul>
          </li>
          <li>
            <strong>Microphone:</strong> your browser will ask for permission. Allow it. You may need to switch between devices to get it to work.
          </li>
          <li>
            <strong>Audio File:</strong> load a supported audio file and press Play.
          </li>
          <li>
            <strong>Display Modes:</strong>
            <ul>
              <li>Waveform: time-domain signal with afterglow effect.</li>
              <li>FFT: frequency spectrum in real time.</li>
              <li>Stereo Phase: left vs right channel Lissajous pattern.</li>
              <li>3D Waveform flat: 3D waveform flat view animation. Tweak the smoothing.</li>
              <li>3D Waveform top: 3D waveform top view.</li>
            </ul>
          </li>
          <li>
            Adjust Afterglow and other parameters using the controls.
          </li>
          <li>
            Drag the controls window by its header; collapse it to free space.
          </li>
          <li>
            More updates will follow...
          </li>
        </ul>
      </div>
      <footer>
        <button class="retro-btn" style="color:white; border: 1px solid white;" id="closeInstructions">Close</button>
      </footer>
    </div>
  </div>

  <canvas id="oscilloscope"></canvas>

  <script src="js/themes.js"></script>
  <script src="js/knob.js"></script>
  <script src="js/audio.js"></script>
  <script src="js/visualizer.js"></script>
  <script src="js/main.js"></script>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // --- Draggable controls ---
    const controls = document.getElementById('controls');
    const header = document.getElementById('controlsHeader');
    let pos = {x:0,y:0}, dragging=false, origin={x:0,y:0};
    header.addEventListener('mousedown', (e)=>{
      dragging = true; origin.x = e.clientX; origin.y = e.clientY;
      const rect = controls.getBoundingClientRect(); pos.x = rect.left; pos.y = rect.top;
      document.body.style.cursor = 'move';
    });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.cursor='default'; });
    window.addEventListener('mousemove', (e)=>{
      if(!dragging) return;
      const dx = e.clientX - origin.x; const dy = e.clientY - origin.y;
      controls.style.left = (pos.x + dx) + 'px';
      controls.style.top = (pos.y + dy) + 'px';
    });
    // Collapse toggle
    const collapseBtn = document.getElementById('collapseBtn');
    collapseBtn.addEventListener('click', ()=>{
      controls.classList.toggle('window-collapsed');
      collapseBtn.textContent = controls.classList.contains('window-collapsed') ? 'Expand' : 'Collapse';
    });
    // Instructions modal
    const modal = document.getElementById('instructionsModal');
    document.getElementById('instructionsBtn').addEventListener('click', ()=>{ modal.style.display = 'flex'; });
    document.getElementById('closeInstructions').addEventListener('click', ()=>{ modal.style.display = 'none'; });
    modal.addEventListener('click', (e)=>{ if(e.target === modal) modal.style.display='none'; });

    // --- SETTINGS TO URL ---
    const themeSelect = document.getElementById("themeSelect");
    const displayMode = document.getElementById("displayMode");
    const afterglowControl = document.getElementById("afterglowControl");
    const afterglowValue = document.getElementById("afterglowValue");

    if (!themeSelect || !displayMode || !afterglowControl || !afterglowValue) return;

    // Load settings from URL
    const params = new URLSearchParams(window.location.search);
    if (params.has("theme")) themeSelect.value = params.get("theme");
    if (params.has("displayMode")) displayMode.value = params.get("displayMode");
    if (params.has("afterglow")) {
      afterglowControl.value = parseFloat(params.get("afterglow")) * 100;
      afterglowValue.textContent = params.get("afterglow");
    }

    function updateURL() {
      const settings = {
        theme: themeSelect.value,
        displayMode: displayMode.value,
        afterglow: (afterglowControl.value/100).toFixed(2)
      };
      const newParams = new URLSearchParams(settings);
      const newURL = `${window.location.origin}${window.location.pathname}?${newParams}`;
      window.history.replaceState({}, "", newURL);
    }

    themeSelect.addEventListener("change", updateURL);
    displayMode.addEventListener("change", updateURL);
    afterglowControl.addEventListener("input", () => {
      afterglowValue.textContent = (afterglowControl.value/100).toFixed(2);
      updateURL();
    });

    // Copy settings button
    const copyBtn = document.createElement("button");
    copyBtn.textContent = "Copy Settings URL";
    copyBtn.className = "retro-btn";
    themeSelect.parentElement.after(copyBtn);
    copyBtn.addEventListener("click", () => {
      navigator.clipboard.writeText(window.location.href);
      copyBtn.textContent = "Copied!";
      setTimeout(() => copyBtn.textContent = "Copy Settings URL", 1500);
    });

  });
  </script>
</body>
</html>
